name: windows-msbuild

on:
  push:
    branches:
      - "**"
  pull_request: {}
  workflow_dispatch: {}

jobs:
  dummy-certs-linux:
    runs-on: ubuntu-latest
    env:
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_PREFIX: ${{ github.workspace }}/openssl-1.1.1w
    steps:
      - uses: actions/checkout@v4

      - name: Restore OpenSSL cache
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_PREFIX }}
          key: openssl-${{ env.OPENSSL_VERSION }}-linux

      - name: Build OpenSSL 1.1.1w
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/openssl/openssl/archive/refs/tags/OpenSSL_1_1_1w.tar.gz
          tar xf OpenSSL_1_1_1w.tar.gz
          cd openssl-OpenSSL_1_1_1w
          ./config --prefix=${OPENSSL_PREFIX} no-shared enable-ssl3 enable-ssl3-method enable-weak-ssl-ciphers
          make -j$(nproc)
          make install
          make install_sw

      - name: Generate dummy-certs
        run: |
          mkdir dummy-certs
          cd dummy-certs
          curl -LO https://larsenv.github.io/NintendoCerts/WII_NWC_1_CERT.p12
          ${OPENSSL_PREFIX}/bin/openssl pkcs12 -in WII_NWC_1_CERT.p12 -passin pass:alpine -passout pass:alpine -out keys.txt
          sed -n '7,29p'  keys.txt > nwc.crt
          sed -n '33,50p' keys.txt > nwc.key
          ${OPENSSL_PREFIX}/bin/openssl genrsa -out server.key 1024
          printf "US\nWashington\nRedmond\nNintendo of America Inc.\nNintendo Wifi Network\n*.*.*\nca@noa.nintendo.com\n\n\n" | \
            ${OPENSSL_PREFIX}/bin/openssl req -new -key server.key -out server.csr
          ${OPENSSL_PREFIX}/bin/openssl x509 -req -in server.csr -CA nwc.crt -CAkey nwc.key -CAcreateserial -out server.crt -days 3650 -sha1 -passin pass:alpine
          cat server.crt nwc.crt > server_with_chain.crt
          rm WII_NWC_1_CERT.p12 keys.txt nwc.key nwc.srl server.csr

      - name: Upload dummy-certs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dummy-certs
          path: dummy-certs
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    env:
      BUILD_DIR: cmake-build-debug
      OPENSSL_VERSION: 3.0.19
      OPENSSL_SRC: ${{ github.workspace }}\openssl\openssl
      OPENSSL_INSTALL: ${{ github.workspace }}\openssl\install
    steps:
      - uses: actions/checkout@v4

      - name: Restore OpenSSL cache
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_INSTALL }}
          key: openssl-${{ env.OPENSSL_VERSION }}-windows-msvc

      - uses: ilammy/msvc-dev-cmd@v1
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        with:
          arch: x64

      - name: Download OpenSSL source
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        run: |
          $tag = "openssl-${{ env.OPENSSL_VERSION }}"
          $dir = "openssl-${{ env.OPENSSL_VERSION }}"
          $base = "${{ github.workspace }}\openssl"
          
          New-Item -ItemType Directory -Force $base | Out-Null
          Set-Location $base
          
          Invoke-WebRequest `
            -Uri "https://github.com/openssl/openssl/releases/download/$tag/$dir.tar.gz" `
            -OutFile "openssl.tar.gz"
          
          tar -xzf openssl.tar.gz
          Rename-Item $dir openssl

      - name: Build OpenSSL (MSVC)
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        working-directory: ${{ env.OPENSSL_SRC }}
        run: |
          perl Configure VC-WIN64A shared enable-ssl3 enable-ssl3-method enable-weak-ssl-ciphers no-tests no-module --prefix="${{ env.OPENSSL_INSTALL }}" --openssldir="${{ env.OPENSSL_INSTALL }}" no-makedepend
          nmake
          nmake install_sw

      - name: Configure CMake
        run: |
          cmake -S . -B "${{ env.BUILD_DIR }}" -G "Visual Studio 17 2022" -A x64 -DOPENSSL_ROOT_DIR="${{ env.OPENSSL_INSTALL }}"

      - name: Build (MSBuild with PDB)
        run: |
          msbuild "${{ env.BUILD_DIR }}\\dq9-server.sln" /p:Configuration=Debug /p:Platform=x64 /p:DebugSymbols=true /p:DebugType=full

      - name: Copy OpenSSL DLLs
        run: |
          Copy-Item "${{ env.OPENSSL_INSTALL }}\\bin\\libcrypto-3-x64.dll" "${{ env.BUILD_DIR }}\Debug" -Force
          Copy-Item "${{ env.OPENSSL_INSTALL }}\\bin\\libssl-3-x64.dll" "${{ env.BUILD_DIR }}\Debug" -Force

      - name: Ensure dlc directory
        run: |
          New-Item -ItemType Directory -Force "${{ env.BUILD_DIR }}\\Debug\\dlc" | Out-Null

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msbuild
          path: |
            ${{ env.BUILD_DIR }}\Debug

  merge-artifacts-linux:
    runs-on: ubuntu-latest
    needs:
      - dummy-certs-linux
      - build
    steps:
      - name: Download windows build artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-msbuild
          path: merged/windows

      - name: Download dummy-certs artifact
        uses: actions/download-artifact@v4
        with:
          name: dummy-certs
          path: merged/dummy-certs

      - name: Merge dummy-certs into windows build
        run: |
          set -e
          echo "Merging dummy-certs into windows build output"

          mkdir -p merged/windows/dummy-certs
          cp -r merged/dummy-certs/* merged/windows/dummy-certs/

          echo "Merge completed"

      - name: Upload merged artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msbuild-with-dummy-certs
          path: merged/windows


